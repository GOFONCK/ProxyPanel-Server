# Подключение к прокси через панель управления

## Архитектура системы

```
Клиент → Панель (8080/8090) → Нода (1080) → Xray → Интернет
```

- **Панель управления** (`panel_server.py`) - порты **8080** (HTTP) и **8090** (SOCKS5)
- **Нода** (`xray_node.py`) - порт **1080** (внутренний, для панели)
- **Xray** - порт **10808** (внутренний, для ноды)

## Шаг 1: Запуск панели управления

Панель управления должна быть запущена на сервере **178.158.227.243**:

```bash
# На сервере панели (178.158.227.243)
cd /path/to/proxypanel
source venv/bin/activate
python3 panel_server.py
```

Должны увидеть:
```
HTTP Proxy:    0.0.0.0:8080
SOCKS5 Proxy:  0.0.0.0:8090
Client API:    0.0.0.0:8000
Node API:      0.0.0.0:3333
```

## Шаг 2: Проверка в веб-панели

1. Откройте веб-панель: http://178.158.227.243:5000/login
   - Логин: `admin`
   - Пароль: `admin123`

2. Проверьте, что нода видна:
   - Перейдите в раздел **"Ноды"**
   - Должна быть видна нода `xray-node-001` со статусом "Активна"

3. Если ноды нет, добавьте её:
   - **ID ноды:** `xray-node-001`
   - **Название:** `Xray Node`
   - **IP/Хост:** `IP_вашей_ноды` (IP сервера где запущена нода)
   - **Порт:** `1080`
   - **Тип:** `SOCKS5`
   - **Токен:** `node_secret_token_123` (должен совпадать с AUTH_TOKEN в xray_node.py)

## Шаг 3: Создание пользователя

1. Перейдите в раздел **"Пользователи"**
2. Добавьте пользователя:
   - **Логин:** например `user1`
   - **Пароль:** например `pass1`
   - **Лимит устройств:** например `5`
3. Нажмите **"Добавить"**

## Шаг 4: Назначение ноды пользователю

1. Перейдите в раздел **"Назначения"**
2. Выберите пользователя и ноду
3. Нажмите **"Назначить"**

## Шаг 5: Подключение через прокси

### Через HTTP прокси (порт 8080)

#### В браузере (Chrome/Firefox):

**Chrome:**
```bash
google-chrome --proxy-server="http://user1:pass1@178.158.227.243:8080"
```

**Firefox:**
1. Настройки → Сеть → Настройки
2. Ручная настройка прокси
3. HTTP прокси: `178.158.227.243`, порт: `8080`
4. Использовать этот прокси-сервер для всех протоколов
5. Учетные данные: `user1` / `pass1`

#### Через curl:
```bash
curl -x http://user1:pass1@178.158.227.243:8080 http://ifconfig.me
```

#### Через wget:
```bash
wget --proxy=on --http-proxy=user1:pass1@178.158.227.243:8080 http://ifconfig.me
```

### Через SOCKS5 прокси (порт 8090)

#### В браузере:

**Chrome:**
```bash
google-chrome --proxy-server="socks5://user1:pass1@178.158.227.243:8090"
```

**Firefox:**
1. Настройки → Сеть → Настройки
2. Ручная настройка прокси
3. SOCKS5 прокси: `178.158.227.243`, порт: `8090`
4. Использовать SOCKS5 прокси-сервер для всех протоколов
5. Учетные данные: `user1` / `pass1`

#### Через curl (с proxychains):
```bash
# Установите proxychains
sudo apt install proxychains4

# Настройте /etc/proxychains4.conf
echo "socks5 178.158.227.243 8090 user1 pass1" >> /etc/proxychains4.conf

# Используйте
proxychains4 curl http://ifconfig.me
```

#### Через SSH:
```bash
ssh -o ProxyCommand="nc -X 5 -x user1:pass1@178.158.227.243:8090 %h %p" user@destination
```

## Примеры конфигурации клиентов

### Proxifier / ProxyCap

**HTTP прокси:**
- Тип: HTTP
- Адрес: `178.158.227.243`
- Порт: `8080`
- Имя пользователя: `user1`
- Пароль: `pass1`

**SOCKS5 прокси:**
- Тип: SOCKS5
- Адрес: `178.158.227.243`
- Порт: `8090`
- Имя пользователя: `user1`
- Пароль: `pass1`

### curl с переменными окружения

```bash
export http_proxy="http://user1:pass1@178.158.227.243:8080"
export https_proxy="http://user1:pass1@178.158.227.243:8080"
export all_proxy="socks5://user1:pass1@178.158.227.243:8090"

curl http://ifconfig.me
```

### Python requests

```python
import requests

# HTTP прокси
proxies = {
    'http': 'http://user1:pass1@178.158.227.243:8080',
    'https': 'http://user1:pass1@178.158.227.243:8080'
}
response = requests.get('http://ifconfig.me', proxies=proxies)
print(response.text)

# SOCKS5 прокси (нужен requests[socks])
proxies = {
    'http': 'socks5://user1:pass1@178.158.227.243:8090',
    'https': 'socks5://user1:pass1@178.158.227.243:8090'
}
response = requests.get('http://ifconfig.me', proxies=proxies)
print(response.text)
```

## Проверка подключения

### 1. Проверьте IP адрес:
```bash
curl -x http://user1:pass1@178.158.227.243:8080 http://ifconfig.me
```

Должен показать IP ноды (где запущен Xray).

### 2. Проверьте через веб-панель:

- Перейдите в раздел **"Логи"** - должны быть видны подключения
- Перейдите в раздел **"Статистика"** - должен быть виден трафик

### 3. Проверьте логи ноды:

На сервере где запущена нода должны быть видны подключения:
```
[XRAY NODE] Подключение к ...
```

## Troubleshooting

### Ошибка: "Connection refused" на 8080/8090

**Причина:** Панель управления не запущена.

**Решение:**
```bash
# На сервере панели (178.158.227.243)
source venv/bin/activate
python3 panel_server.py
```

### Ошибка: "Invalid credentials"

**Причина:** Неправильные имя пользователя или пароль.

**Решение:**
- Проверьте учетные данные в веб-панели
- Убедитесь, что используете правильный логин/пароль

### Ошибка: "No nodes assigned"

**Причина:** Пользователю не назначена нода.

**Решение:**
1. Откройте веб-панель
2. Перейдите в **"Назначения"**
3. Назначьте ноду пользователю

### Ошибка: "No active nodes assigned"

**Причина:** Нода неактивна.

**Решение:**
1. Откройте веб-панель
2. Перейдите в **"Ноды"**
3. Убедитесь, что нода активна (зеленый статус)
4. Если нет - активируйте кнопкой "Активировать"

### Ошибка: "Failed to connect to node"

**Причина:** Нода недоступна или не запущена.

**Решение:**
- Убедитесь, что нода запущена
- Проверьте IP адрес и порт ноды в веб-панели
- Проверьте firewall на сервере ноды

## Быстрая проверка всей цепочки

```bash
# 1. Панель работает?
curl http://178.158.227.243:8000/api/health

# 2. Подключение через HTTP прокси?
curl -x http://user1:pass1@178.158.227.243:8080 http://ifconfig.me

# 3. Подключение через SOCKS5?
curl --socks5 user1:pass1@178.158.227.243:8090 http://ifconfig.me
```

## Прямое подключение к ноде (без панели)

Если нужно подключиться напрямую к ноде (без панели):

**Важно:** Нода принимает подключения на порту **1080**, но это порт для внутреннего использования панелью. Для прямого подключения клиентов ноду нужно настроить отдельно (это не рекомендуется).

Рекомендуется использовать панель управления на портах 8080/8090 - она обеспечивает:
- Аутентификацию пользователей
- Назначение нод
- Мониторинг и логирование
- Статистику трафика
- Управление пользователями

