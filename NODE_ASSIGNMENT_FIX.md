# Исправление проблемы с назначением нод

## Проблема
При удалении старой ноды и назначении новой, трафик продолжал идти через старую ноду.

## Решение

### 1. Автоматическое удаление старых назначений
Теперь при назначении новой ноды пользователю, **все старые назначения автоматически удаляются**.

### 2. Исправлена функция `get_user_nodes`
Добавлен `ORDER BY` для правильной сортировки нод по времени назначения.

### 3. Оптимизирована логика выбора ноды
- Если у пользователя только одна нода - используется она
- Если несколько нод - выбирается с наименьшей нагрузкой

## Как это работает теперь:

1. **Назначение одной ноды:**
   - Удаляются все старые назначения
   - Добавляется новая нода
   - Пользователь использует только эту ноду

2. **Замена ноды:**
   - Удаляете старую ноду в разделе "Назначения"
   - Назначаете новую ноду
   - Старая автоматически удаляется, новая сразу работает

3. **Массовое назначение:**
   - Если выбрана одна нода - заменяет все существующие
   - Если выбрано несколько - добавляет к существующим

## Проверка:

1. Назначьте пользователю ноду 1
2. Проверьте подключение - должен использоваться IP ноды 1
3. Удалите ноду 1 и назначьте ноду 2
4. Проверьте подключение - должен использоваться IP ноды 2

```bash
# Проверка IP
curl --socks5-hostname user1:pass1@178.158.227.243:8090 https://api.ipify.org
```

## Важно:

- При назначении новой ноды старая **автоматически удаляется**
- Не нужно вручную удалять старую ноду перед назначением новой
- Система сразу переключается на новую ноду



