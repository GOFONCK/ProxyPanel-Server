# Оптимизация для больших нагрузок (100-1000+ пользователей)

Это руководство поможет оптимизировать ноду для обработки больших нагрузок с 100-1000+ одновременными пользователями.

## Настройки в xray_node.py

### Увеличенные лимиты подключений

В `xray_node.py` уже настроено для больших нагрузок:

```python
MAX_CONCURRENT_CONNECTIONS = 2000  # Увеличено с 500 до 2000
```

### Отключено логирование для производительности

```python
LOG_CONNECTIONS = False  # ВЫКЛЮЧЕНО - не логирует каждое подключение
LOG_DISCONNECTIONS = False  # ВЫКЛЮЧЕНО - не логирует завершение соединений
LOG_SSL_ERRORS = False  # ВЫКЛЮЧЕНО - не логирует SSL ошибки
LOG_LEVEL = logging.WARNING  # Только предупреждения и ошибки
```

## Системные настройки для больших нагрузок

### 1. Увеличение лимита файловых дескрипторов

**Критически важно!** Каждое соединение использует файловый дескриптор. Для 1000+ соединений нужно увеличить лимит.

#### Проверка текущего лимита:
```bash
ulimit -n
```

#### Увеличение лимита (временное, для текущей сессии):
```bash
ulimit -n 65536  # или больше
```

#### Постоянное увеличение лимита:

**Для systemd (рекомендуется):**

Создайте файл `/etc/systemd/system/xray-node.service`:

```ini
[Unit]
Description=Xray Node Proxy Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt
ExecStart=/usr/bin/python3 /opt/xray_node.py
Restart=always
RestartSec=5

# Увеличение лимитов для больших нагрузок
LimitNOFILE=65536
LimitNPROC=32768

[Install]
WantedBy=multi-user.target
```

Затем:
```bash
sudo systemctl daemon-reload
sudo systemctl enable xray-node
sudo systemctl start xray-node
```

**Для /etc/security/limits.conf:**

Добавьте в `/etc/security/limits.conf`:
```
* soft nofile 65536
* hard nofile 65536
* soft nproc 32768
* hard nproc 32768
```

После этого перелогиньтесь или перезагрузите систему.

**Для запуска через скрипт:**

Добавьте в начало `run_xray_node.sh`:
```bash
# Увеличение лимита файловых дескрипторов
ulimit -n 65536
ulimit -u 32768
```

### 2. Оптимизация TCP параметров ядра Linux

Добавьте в `/etc/sysctl.conf`:

```bash
# Оптимизация TCP для больших нагрузок
net.core.somaxconn = 4096
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 4096

# Увеличение портового диапазона
net.ipv4.ip_local_port_range = 1024 65535

# TCP оптимизация
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15

# Увеличение буферов для больших нагрузок
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# Отключение syncookies (если не нужны для защиты)
# net.ipv4.tcp_syncookies = 0
```

Примените изменения:
```bash
sudo sysctl -p
```

### 3. Оптимизация Python

**Используйте более быструю реализацию Python:**
- Python 3.11+ имеет улучшенную производительность
- Рассмотрите использование PyPy для дополнительного ускорения

**Настройки окружения:**
```bash
# Увеличить размер стека потоков (если нужно)
export PYTHONTHREADDEBUG=0  # Отключить отладочную информацию потоков
```

### 4. Мониторинг ресурсов

**Установите мониторинг:**
```bash
# htop для мониторинга CPU и RAM
sudo apt install htop

# iotop для мониторинга I/O
sudo apt install iotop

# netstat для мониторинга соединений
sudo apt install net-tools
```

**Проверка активных соединений:**
```bash
# Количество активных соединений к ноде
netstat -an | grep :1080 | grep ESTABLISHED | wc -l

# Или с ss (более быстро)
ss -an | grep :1080 | grep ESTAB | wc -l
```

## Настройки Xray для больших нагрузок

В файле `/opt/xray_config.json` убедитесь, что Xray оптимизирован:

```json
{
  "log": {
    "loglevel": "none"  // Отключить логирование Xray для производительности
  },
  "inbounds": [
    {
      "port": 10808,
      "protocol": "socks",
      "settings": {
        "auth": "noauth",
        "udp": true,
        "timeout": 0,  // Убрать таймаут
        "userLevel": 0
      },
      "sniffing": {
        "enabled": false  // Отключить sniffing для производительности
      }
    }
  ],
  "outbounds": [
    // ваши outbounds
  ]
}
```

## Рекомендации по оборудованию

### Для 100-500 пользователей:
- **CPU**: 2-4 ядра
- **RAM**: 4-8 GB
- **Network**: 100+ Mbps
- **MAX_CONCURRENT_CONNECTIONS**: 1000-1500

### Для 500-1000 пользователей:
- **CPU**: 4-8 ядер
- **RAM**: 8-16 GB
- **Network**: 500+ Mbps
- **MAX_CONCURRENT_CONNECTIONS**: 2000-3000

### Для 1000+ пользователей:
- **CPU**: 8+ ядер
- **RAM**: 16+ GB
- **Network**: 1+ Gbps
- **MAX_CONCURRENT_CONNECTIONS**: 3000-5000
- Рассмотрите использование нескольких нод для балансировки

## Настройка панели для больших нагрузок

### Увеличение лимитов подключений в panel_server.py

Проверьте настройки панели, чтобы она могла обрабатывать много одновременных подключений к нодам.

### База данных

Для больших нагрузок рекомендуется:
- Использовать PostgreSQL вместо SQLite
- Настроить connection pooling
- Добавить индексы для быстрого поиска

## Проверка производительности

### Стресс-тест подключений:

```bash
# Тест с помощью Apache Bench (если установлен)
# Или используйте специализированные инструменты для тестирования прокси
```

### Мониторинг в реальном времени:

```bash
# Следить за количеством подключений
watch -n 1 'ss -an | grep :1080 | grep ESTAB | wc -l'

# Следить за использованием ресурсов
htop
```

## Оптимизация при перегрузке

Если нода перегружена, система автоматически:
1. Отклоняет новые подключения при достижении 95% лимита
2. Быстро закрывает отклоненные соединения
3. Логирует предупреждения каждые 50 отклонений

### Признаки перегрузки:
- Частые таймауты подключения к ноде из панели
- Предупреждения "Высокая нагрузка" в логах
- Высокая задержка при подключении

### Решения:
1. Увеличьте `MAX_CONCURRENT_CONNECTIONS`
2. Добавьте больше нод и распределите пользователей
3. Увеличьте системные ресурсы (CPU, RAM)
4. Оптимизируйте сетевые настройки

## Часто задаваемые вопросы

**Q: Сколько пользователей может обработать одна нода?**  
A: Зависит от ресурсов сервера. При правильной настройке: 500-2000 одновременных подключений.

**Q: Как распределить 1000 пользователей на несколько нод?**  
A: Создайте несколько нод и назначьте их разным пользователям или используйте балансировку в панели.

**Q: Нода показывает высокую нагрузку, что делать?**  
A: Увеличьте `MAX_CONCURRENT_CONNECTIONS` или добавьте больше нод.

**Q: Как проверить, не достигнут ли лимит файловых дескрипторов?**  
A: Проверьте логи на ошибки "Too many open files" или выполните `lsof | wc -l`.


