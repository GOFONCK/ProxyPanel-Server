# Proxy Panel - Система управления прокси с распределенными нодами

Централизованная система управления прокси-серверами с поддержкой распределенных нод.

## Архитектура

- **Панель управления** - центральный сервер для управления пользователями, нодами и статистикой
- **Ноды** - распределенные прокси-серверы, которые подключаются к панели
- **Клиенты** - пользователи подключаются к панели, трафик перенаправляется на назначенные ноды

## Компоненты

1. **panel_server.py** - Главный сервер панели
   - HTTP прокси (порт 8080)
   - SOCKS5 прокси (порт 8090)
   - REST API для клиентов (порт 8000)
   - API для нод (порт 3333)

2. **web_panel.py** - Веб-интерфейс администратора (порт 5000)
   - Управление пользователями
   - Управление нодами
   - Назначение нод пользователям
   - Просмотр статистики и логов

3. **node_client.py** - Базовая нода
   - Подключается к панели управления
   - Обрабатывает прокси-запросы от пользователей
   - Отправляет heartbeat в панель

4. **shadowsokcs.py** - Нода с мостом Shadowsocks
   - Работает как обычная нода
   - Проксирует трафик через Shadowsocks клиент
   - Подробнее: см. комментарии в файле

5. **xray_node.py** - Нода с интеграцией Xray
   - Работает как обычная нода
   - Проксирует трафик через Xray (VMess, VLESS, Trojan, Shadowsocks, SOCKS5)
   - Поддерживает автоматический запуск Xray
   - Подробнее: см. `XRAY_NODE_SETUP.md`

6. **database.py** - Модуль работы с базой данных

## Установка

1. **Установите зависимости (рекомендуется через виртуальное окружение):**

Если вы получили ошибку `externally-managed-environment`, используйте виртуальное окружение:

```bash
# Создайте виртуальное окружение
python3 -m venv venv

# Активируйте его
source venv/bin/activate

# Установите зависимости
pip install -r requirements.txt
```

Или вручную:
```bash
pip install Flask pyjwt requests PySocks
```

**Каждый раз при запуске активируйте виртуальное окружение:**
```bash
source venv/bin/activate
```

**Если нужно установить системно (не рекомендуется):**
```bash
pip3 install --break-system-packages -r requirements.txt
```

**Подробнее:** См. `INSTALL_DEPS.md` для всех способов установки.

2. Запустите панель управления:
```bash
python panel_server.py
```

3. В другом терминале запустите веб-панель:
```bash
python web_panel.py
```

4. Для тестирования запустите ноду (опционально):
```bash
# Базовая нода
python node_client.py

# Нода с Shadowsocks мостом
python shadowsokcs.py

# Нода с Xray интеграцией
python xray_node.py
```

## Настройка

### Панель управления (panel_server.py)

Измените конфигурацию в начале файла:
```python
LOCAL_HOST = '0.0.0.0'
HTTP_PORT = 8080
SOCKS5_PORT = 8090
API_PORT = 8000
NODE_API_PORT = 3333
JWT_SECRET = 'CHANGE_THIS_SECRET_KEY_IN_PRODUCTION!!!'
```

### Веб-панель (web_panel.py)

Измените пароль администратора:
```python
ADMIN_PASSWORD_HASH = hashlib.sha256('admin123'.encode()).hexdigest()
```

### Ноды

#### Базовая нода (node_client.py)

Настройте параметры ноды:
```python
NODE_ID = 'node-001'  # Уникальный ID
NODE_NAME = 'Node 1'
NODE_HOST = '127.0.0.1'  # IP адрес ноды
NODE_PORT = 1080  # Порт ноды
NODE_TYPE = 'socks5'  # 'http' или 'socks5'
AUTH_TOKEN = 'node_secret_token_123'  # Токен для панели
PANEL_HOST = '127.0.0.1'  # IP панели
PANEL_PORT = 3333  # Порт API панели
```

#### Нода с Shadowsocks мостом (shadowsokcs.py)

Работает как базовая нода, но проксирует трафик через Shadowsocks клиент:
```python
NODE_ID = 'shadowsocks-bridge-001'
SS_HOST = '127.0.0.1'  # Адрес Shadowsocks клиента
SS_PORT = 1080  # Порт Shadowsocks клиента
```

**Требования:** `pip install PySocks`

#### Нода с Xray интеграцией (xray_node.py)

Работает как базовая нода, но проксирует трафик через Xray (VMess, VLESS, Trojan, Shadowsocks):
```python
NODE_ID = 'xray-node-001'
XRAY_SOCKS5_HOST = '127.0.0.1'  # Адрес Xray SOCKS5 прокси
XRAY_SOCKS5_PORT = 10808  # Порт Xray SOCKS5 прокси
XRAY_MODE = 'socks5'  # 'socks5', 'vmess', 'vless', 'trojan'
AUTO_START_XRAY = False  # Автоматический запуск Xray
```

**Требования:** 
- `pip install PySocks`
- Установленный Xray (см. `XRAY_NODE_SETUP.md`)

Подробнее о настройке Xray ноды: см. `XRAY_NODE_SETUP.md`

## Использование

### 1. Доступ к веб-панели

Откройте в браузере: `http://127.0.0.1:5000/login`

**Логин по умолчанию:**
- Логин: `admin`
- Пароль: `admin123`

⚠️ **ВАЖНО:** Смените пароль администратора перед использованием в продакшене!

### 2. Добавление ноды

1. В веб-панели перейдите в раздел "Ноды"
2. Заполните форму:
   - **ID ноды** - уникальный идентификатор (например, `node-001`)
   - **Название** - отображаемое имя
   - **IP/Хост** - адрес ноды
   - **Порт** - порт ноды
   - **Тип** - HTTP или SOCKS5
   - **Токен** - токен аутентификации (должен совпадать с токеном в node_client.py)

3. Нажмите "Добавить"

### 3. Добавление пользователя

1. Перейдите в раздел "Пользователи"
2. Заполните форму:
   - **Логин** - имя пользователя
   - **Пароль** - пароль пользователя
   - **Лимит устройств** - максимальное количество одновременных подключений

3. Нажмите "Добавить"

### 4. Назначение ноды пользователю

1. Перейдите в раздел "Назначения"
2. Выберите пользователя и ноду
3. Нажмите "Назначить"

Теперь пользователь будет использовать эту ноду для проксирования трафика.

### 5. Подключение клиента

Пользователь может подключиться к прокси используя:

**HTTP прокси:**
```
Адрес: IP_ПАНЕЛИ
Порт: 8080
Аутентификация: Basic Auth (логин/пароль пользователя)
```

**SOCKS5 прокси:**
```
Адрес: IP_ПАНЕЛИ
Порт: 8090
Аутентификация: Username/Password (логин/пароль пользователя)
```

**REST API:**
```bash
curl -X POST http://IP_ПАНЕЛИ:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username": "user1", "password": "pass1"}'
```

## Структура базы данных

- **users** - пользователи системы
- **nodes** - зарегистрированные ноды
- **user_nodes** - назначения нод пользователям
- **active_sessions** - активные сессии пользователей
- **traffic_stats** - статистика трафика
- **connection_logs** - логи подключений

## Безопасность

⚠️ **ВАЖНЫЕ РЕКОМЕНДАЦИИ:**

1. Смените все секретные ключи и пароли перед использованием
2. Используйте HTTPS для веб-панели в продакшене
3. Ограничьте доступ к портам файрволом
4. Используйте сильные токены для нод
5. Регулярно проверяйте логи на подозрительную активность

## Разработка

### Добавление новых функций

- **Новые API endpoints** - добавьте в `panel_server.py`
- **Новые страницы веб-панели** - добавьте маршруты в `web_panel.py`
- **Новые таблицы БД** - добавьте в `database.py` в функцию `setup_database()`

## Лицензия

MIT License



Анализирую проект и предлагаю полезные дополнения:


[3 tools called]


Предлагаю полезные дополнения для проекта:

## Рекомендуемые дополнения

### 1. Telegram-бот для управления
- Уведомления о статусе нод
- Быстрое управление пользователями
- Просмотр статистики
- Алерты о проблемах

### 2. Система уведомлений
- Email-уведомления (критические события)
- Telegram-уведомления
- Webhook для интеграций
- Настраиваемые триггеры

### 3. Геолокация и IP-информация
- Определение страны/города по IP
- Визуализация на карте
- Статистика по странам
- Блокировка по геолокации

### 4. Real-time мониторинг (WebSocket)
- Обновление статистики в реальном времени
- Мониторинг нод без перезагрузки
- Живые графики трафика
- Уведомления в браузере

### 5. Система тестирования нод
- Автоматический ping нод
- Проверка доступности
- Тест скорости подключения
- Автоматическое отключение неработающих нод

### 6. Расширенная аналитика
- Графики использования по времени
- Топ пользователей по трафику
- Анализ паттернов использования
- Прогнозирование нагрузки

### 7. Система шаблонов конфигураций
- Шаблоны для клиентов (SOCKS5, HTTP)
- Автоматическая генерация конфигов
- Экспорт в различные форматы
- QR-коды для быстрой настройки

### 8. API для клиентов
- Получение статистики пользователя
- Управление сессиями
- История подключений
- Информация о назначенных нодах

### 9. Система рефералов
- Реферальные ссылки
- Бонусы за приглашения
- Статистика рефералов
- Автоматическое начисление

### 10. Автоматическое масштабирование
- Автоматическое добавление нод при нагрузке
- Балансировка нагрузки
- Автоматическое переключение при падении ноды
- Мониторинг и восстановление

### 11. Система биллинга (базовая)
- Тарифные планы
- Автоматическое списание
- История платежей
- Интеграция с платежными системами

### 12. Многоязычность
- Поддержка нескольких языков
- Переключение языка в интерфейсе
- Локализация дат и чисел

### 13. Система тикетов/поддержки
- Тикеты пользователей
- История обращений
- Автоматические ответы
- Приоритеты и категории

### 14. Расширенная безопасность
- IP-геоблокировка
- Автоматический бан при подозрительной активности
- Логирование всех действий
- Аудит безопасности

### 15. Мобильная версия/адаптивность
- Полностью адаптивный дизайн
- PWA для мобильных устройств
- Push-уведомления
- Оптимизация для планшетов

## Приоритетные (быстро реализуемые)

1. Telegram-бот — быстрая реализация, высокая полезность
2. Real-time мониторинг (WebSocket) — улучшает UX
3. Геолокация IP — полезная аналитика
4. Система тестирования нод — повышает надежность
5. API для клиентов — расширяет возможности
