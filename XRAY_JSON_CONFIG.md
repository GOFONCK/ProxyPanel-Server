# Использование JSON конфигурации для Xray ноды

Это руководство объясняет, как использовать ваш собственный JSON конфиг Xray (например, с VLESS-TCP-REALITY) с нодой.

## Быстрый старт

1. **Создайте файл конфигурации** `xray_config.json` с вашей конфигурацией Xray (см. пример ниже)

2. **Настройте `xray_node.py`**:

```python
# Включите автоматический запуск Xray
AUTO_START_XRAY = True

# Укажите путь к Xray
XRAY_BINARY_PATH = '/usr/local/bin/xray'  # или путь где установлен Xray

# Укажите путь к вашему JSON конфигу
XRAY_CONFIG_PATH = 'xray_config.json'  # или полный путь '/path/to/xray_config.json'

# Порт SOCKS5 inbound (будет добавлен автоматически если отсутствует)
XRAY_SOCKS5_PORT = 10808
```

3. **Запустите ноду**:

```bash
python3 xray_node.py
```

## Как это работает

1. Нода загружает ваш JSON конфиг из указанного файла
2. Если в конфиге нет SOCKS5 inbound, нода автоматически добавляет его на порту `10808` (по умолчанию)
3. Нода запускает Xray с этой конфигурацией
4. Нода подключается к SOCKS5 inbound и проксирует трафик клиентов через ваш Xray сервер

## Пример конфигурации

Пример конфигурации с VLESS-TCP-REALITY находится в файле `xray_config_example.json`.

Вы можете использовать его как шаблон:

```bash
# Скопируйте пример
cp xray_config_example.json xray_config.json

# Отредактируйте под свои нужды
nano xray_config.json

# Укажите путь в xray_node.py
XRAY_CONFIG_PATH = 'xray_config.json'
```

## Важные моменты

- **SOCKS5 inbound**: Если в вашем конфиге нет SOCKS5 inbound, нода автоматически добавит его. Это необходимо для работы ноды.

- **Порт SOCKS5**: По умолчанию используется порт `10808`. Вы можете изменить его, установив `XRAY_SOCKS5_PORT` в `xray_node.py`.

- **Совместимость**: Ваш JSON конфиг должен быть валидным конфигом Xray. Нода не изменяет ваши outbounds, routing rules и другие настройки.

- **Автоматическое добавление SOCKS5**: Если в вашем конфиге уже есть SOCKS5 inbound, нода обновит его порт на `XRAY_SOCKS5_PORT`, если он отличается.

## Пример использования с VLESS-TCP-REALITY

Если вы используете конфигурацию с VLESS-TCP-REALITY (как в примере), нода будет работать следующим образом:

1. Клиенты подключаются к ноде через SOCKS5
2. Нода отправляет трафик на Xray через SOCKS5 inbound
3. Xray обрабатывает трафик согласно routing rules
4. Если трафик идет через inbound с тегом `VLESS_TCP_REALITY_testt`, он направляется на outbound `SHADOWSOCKS_REMOTE` (согласно routing rules)

## Проверка работы

После запуска ноды вы должны увидеть в логах:

```
[XRAY] Конфигурация загружена из: xray_config.json
[XRAY] SOCKS5 inbound добавлен на порт 10808
[XRAY] Xray успешно запущен (PID: ...)
[XRAY NODE] Прокси-сервер запущен на 0.0.0.0:1080
[XRAY NODE] Трафик проксируется через Xray SOCKS5: 127.0.0.1:10808
```

## Устранение проблем

### Ошибка: "Конфигурация не загружена"

- Проверьте, что файл существует: `ls -la xray_config.json`
- Проверьте, что путь указан правильно в `XRAY_CONFIG_PATH`
- Проверьте, что JSON файл валиден: `cat xray_config.json | python3 -m json.tool`

### Ошибка: "Xray не запущен"

- Проверьте путь к Xray: `which xray` или `ls -la /usr/local/bin/xray`
- Проверьте, что Xray установлен и имеет права на выполнение: `chmod +x /usr/local/bin/xray`
- Проверьте логи Xray в выводе ноды

### Ошибка: "Не удалось подключиться к Xray SOCKS5"

- Проверьте, что Xray запущен: `ps aux | grep xray`
- Проверьте, что порт SOCKS5 открыт: `netstat -an | grep 10808`
- Проверьте, что в конфиге есть SOCKS5 inbound или что нода добавила его автоматически

## Дополнительная информация

Для более подробной информации см. `XRAY_NODE_SETUP.md`.

